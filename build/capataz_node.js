//! capataz 0.1.2-alpha
!function(a){"use strict";var b=require("creatartis-base"),c=require("express"),d=require("path");a.dependencies={base:b,express:c};var e=a.Capataz=b.declare({constructor:function(a){b.initialize(this.config={},a).integer("workerCount",{defaultValue:2,coerce:!0}).number("maxRetries",{defaultValue:50,coerce:!0}).integer("minDelay",{defaultValue:100,coerce:!0}).number("maxDelay",{defaultValue:12e4,coerce:!0}).integer("useWebworkers",{defaultValue:1,coerce:!0}).number("desiredEvaluationTime",{defaultValue:1e4,coerce:!0}).number("maxTaskSize",{defaultValue:50,coerce:!0}).number("evaluationTimeGainFactor",{defaultValue:.9,coerce:!0}).number("maxScheduled",{defaultValue:5e3,coerce:!0}).integer("port",{defaultValue:8080,coerce:!0}).string("staticRoute",{defaultValue:"/capataz"}).string("serverFiles",{defaultValue:d.dirname(module.filename)+"/static"}).string("customFiles",{defaultValue:""}).string("taskRoute",{defaultValue:"/capataz/task.json"}).string("configRoute",{defaultValue:"/capataz/config.json"}).string("statsRoute",{defaultValue:"/capataz/stats.json"}).func("authentication",{ignore:!0}).bool("compression",{defaultValue:!0,coerce:!0}).string("logFile",{defaultValue:b.Text.formatDate(new Date,'"capataz-"yyyymmdd-hhnnss".log"')}),b.initialize(this,a).object("statistics",{defaultValue:new b.Statistics}).object("logger",{defaultValue:b.Logger.ROOT}).object("jobs",{defaultValue:{}}),this.logger&&(this.logger.appendToConsole(),this.config.logFile&&this.logger.appendToFile(this.config.logFile)),this.__pending__=[],this.__jobCount__=0,this.__startTime__=Date.now()},wrappedJob:function(a,b,c){return"(function(){return base.Future.imports.apply(this,"+JSON.stringify(a||[])+").then(function(deps){return ("+b+").apply(this,deps.concat("+JSON.stringify(c||[])+"));});})()"},schedule:function(a){var c=new b.Future;if(this.scheduledJobsCount()>=this.config.maxScheduled)c.reject(new Error("Cannot schedule more jobs: the maximum amount ("+this.config.maxScheduled+") has been reached."));else{var d={id:(this.__jobCount__=4294967295&++this.__jobCount__).toString(36),info:""+a.info,code:this.wrappedJob(a.imports,a.fun,a.args),future:c,scheduledSince:Date.now(),assignedSince:-1/0};a.tags&&(d.tags=a.tags),this.jobs[d.id]=d,this.statistics.add(b.copy({key:"scheduled"},a.tags))}return c},scheduledJobsCount:function(){return Object.keys(this.jobs).length},taskSize:function(){var a=Math.max(1,this.statistics.average({key:"estimated_time"}));return Math.round(Math.max(1,Math.min(this.config.maxTaskSize,this.config.desiredEvaluationTime/a)))},nextTask:function(a){a=isNaN(a)?this.taskSize():0|+a,this.__pending__.length<1&&(this.__pending__=Object.keys(this.jobs));var c=this.__pending__.splice(0,a),d=this;return{serverStartTime:this.__startTime__,jobs:b.iterable(c).map(function(a){var b=d.jobs[a];return b&&{id:a,info:b.info,code:b.code,assignedSince:Date.now()}}).filter().toArray()}},postIsInvalid:function(a){return isNaN(a.assignedSince)||a.assignedSince<this.__startTime__||a.assignedSince>Date.now()||a.time<=0},processResult:function(a){var b,c=a.id,d=this.jobs[c];delete this.jobs[c],d?this.postIsInvalid(a)?(this.logger.warn("Posted result for ",c," is not valid. Ignoring POST."),this.jobs[c]=d,b="invalid"):"undefined"!=typeof a.error?(b="rejected",d.future.reject(a.error)):(b="resolved",d.future.resolve(a.result)):(this.logger.debug("Job ",a.id," not found. Ignoring POST."),b="ignored"),this.accountPost(a,d,b)},accountPost:function(a,c,d){"resolved"==d&&this.statistics.gain({key:"estimated_time"},a.time,this.config.evaluationTimeGainFactor),this.statistics.add(b.copy({key:"evaluation_time",status:d,platform:a.clientPlatform,client:a.postedFrom},c&&c.tags),a.time),this.statistics.add(b.copy({key:"roundtrip_time",status:d,platform:a.clientPlatform,client:a.postedFrom},c&&c.tags),Date.now()-a.assignedSince)},get_config:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json({jobURI:this.config.taskRoute,workerCount:this.config.workerCount,maxRetries:this.config.maxRetries,minDelay:this.config.minDelay,maxDelay:this.config.maxDelay,useWebworkers:this.config.useWebworkers})},get_task:function(a,b){var c=this.nextTask();return c.jobs.length>0?(b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(c),this.statistics.add({key:"jobs_per_task"},c.jobs.length)):(this.logger.debug("There are no pending jobs yet."),b.send(404,"There are no pending jobs yet. Please try again later.")),!0},post_task:function(a,b){var c=this,d=a.connection.remoteAddress+"";a.body&&Array.isArray(a.body.jobs)?(b.send("Thank you."),a.body.jobs.forEach(function(a){a.postedFrom=d,c.processResult(a)})):b.send(400,"Invalid post.")},get_stats:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(this.statistics)},configureApp:function(a){var b=this.config;return a=a||c(),a.use(c.json()),b.compression&&a.use(c.compress()),a.get("/",function(a,c){c.redirect(b.staticRoute+"/index.html")}),a.get(b.taskRoute,this.get_task.bind(this)),a.post(b.taskRoute,this.post_task.bind(this)),a.get(b.configRoute,this.get_config.bind(this)),a.get(b.statsRoute,this.get_stats.bind(this)),"function"==typeof b.authentication&&[b.staticRoute,b.taskRoute,b.configRoute,b.statsRoute].forEach(function(d){a.use(d,c.basicAuth(b.authentication.bind(this,d)))}),a.use(b.staticRoute,c["static"](b.serverFiles)),b.customFiles.split("\n").forEach(function(d){d=d.trim(),d&&a.use(b.staticRoute,c["static"](d))}),a},"static run":function(a){var b=new e(a),c=b.config.port;return b.logger.info("Setting up the Capataz server."),b.expressApp=b.configureApp(a.app),b.expressApp.listen(c),b.logger.info("Server started and listening at port ",c,"."),b},scheduleAll:function(a,c,d){var e=b.iterable(a).__iter__(),f=this;return c=isNaN(c)?this.config.maxScheduled:Math.min(0|+c,this.config.maxScheduled),b.Future.doWhile(function(){var a,g=[];try{for(var h=0;c>h;++h)a=f.schedule(e()),g.push(d?d(a):a)}catch(i){b.Iterable.prototype.catchStop(i)}return g.length<1?!1:b.Future.all(g)})}})}(exports);