//! capataz 0.1.7-alpha
!function(a){"use strict";var b=require("path"),c=require("fs"),d=require("express"),e=require("creatartis-base"),f=require("sermat");f.modifiers.mode=f.CIRCULAR_MODE,f.include("Function"),a.__package__="capataz_node",a.__name__="capataz_node",a.__dependencies__=[d,e,f],a.__SERMAT__={include:[]};var g=e.copy,h=e.declare,i=e.raiseIf,j=e.initialize,k=e.Text,l=e.iterable,m=e.Iterable,n=e.Future,o=e.Logger,p=e.Statistics,q=require("body-parser"),r=a.Capataz=h({constructor:function(a){j(this.config={},a).integer("workerCount",{defaultValue:2,coerce:!0}).integer("useWebworkers",{defaultValue:1,coerce:!0}).bool("adjustWorkerCount",{defaultValue:!0,coerce:!0}).number("maxRetries",{defaultValue:100,coerce:!0}).integer("minDelay",{defaultValue:100,coerce:!0}).number("maxDelay",{defaultValue:9e5,coerce:!0}).number("desiredEvaluationTime",{defaultValue:1e4,coerce:!0}).number("maxTaskSize",{defaultValue:50,coerce:!0}).number("evaluationTimeGainFactor",{defaultValue:.9,coerce:!0}).number("maxScheduled",{defaultValue:5e3,coerce:!0}).integer("port",{defaultValue:8080,coerce:!0}).string("staticRoute",{defaultValue:"/capataz"}).string("serverFiles",{defaultValue:b.dirname(module.filename)+"/static"}).object("routes",{defaultValue:{}}).func("authentication",{ignore:!0}).bool("compression",{defaultValue:!0,coerce:!0}).string("logFile",{defaultValue:k.formatDate(new Date,'"capataz-"yyyymmdd-hhnnss".log"')}),this.config.customFiles=a.customFiles||[],j(this,a).object("statistics",{defaultValue:new p}).object("logger",{defaultValue:o.ROOT}).object("store",{defaultValue:new t(a)}),this.logger&&(this.logger.appendToConsole(),this.config.logFile&&this.logger.appendToFile(this.config.logFile)),this.__startTime__=Date.now()},schedule:function(a){this.__accountServerStats__(),a.fun||raise("Cannot schedule ",JSON.stringify(a),", it has no `fun`!");var b=this.store.store({info:a.info,imports:a.imports,args:a.args,fun:a.fun,tags:a.tags}).future;return b.fail(this.logger.error.bind(this.logger)),b},__accountServerStats__:function(){var a=this.statistics,b=process.memoryUsage();["rss","heapUsed","heapTotal"].forEach(function(c){a.add({key:"memory",type:c},b[c])})},taskSize:function(){var a=this.statistics.stat({key:"estimated_time"}),b=Math.max(1,a.average());return a.count()<=3?1:Math.round(Math.max(1,Math.min(this.config.maxTaskSize,this.config.desiredEvaluationTime/b)))},nextTask:function(a){return isNaN(a)&&(a=this.taskSize()),{serverStartTime:this.__startTime__,jobs:this.store.task(a).map(function(a){return{id:a.id,info:(a.info||"")+"",imports:a.imports||[],args:a.args||[],fun:a.fun+"",assignedSince:Date.now()}})}},postIsInvalid:function(a){return isNaN(a.assignedSince)||a.assignedSince<this.__startTime__||a.assignedSince>Date.now()||a.time<=0},processResult:function(a){this.__accountServerStats__();var b,c=this.store.assigned(a.id);c?this.postIsInvalid(a)?(this.logger.warn("Posted result for ",a.id," is not valid. Ignoring POST."),b="invalid"):"undefined"!=typeof a.error?(b="rejected",c.future.reject(a.error)):(b="resolved",c.future.resolve(a.result)):(this.logger.debug("Job ",a.id," not found. Ignoring POST."),b="ignored"),c&&this.accountPost(a,c,b)},accountPost:function(a,b,c){"resolved"===c&&this.statistics.gain({key:"estimated_time"},a.time,this.config.evaluationTimeGainFactor),this.statistics.add(g({key:"evaluation_time",status:c,platform:a.clientPlatform,client:a.postedFrom},b&&b.tags),a.time),this.statistics.add(g({key:"roundtrip_time",status:c,platform:a.clientPlatform,client:a.postedFrom},b&&b.tags),Date.now()-a.assignedSince)},get_config:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json({jobURI:this.config.taskRoute,workerCount:this.config.workerCount,adjustWorkerCount:this.config.adjustWorkerCount,maxRetries:this.config.maxRetries,minDelay:this.config.minDelay,maxDelay:this.config.maxDelay,useWebworkers:this.config.useWebworkers})},get_task:function(a,b){var c=this.nextTask();return c.jobs.length>0?(b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(c),this.statistics.add({key:"jobs_per_task"},c.jobs.length)):(this.logger.debug("There are no pending jobs yet."),b.status(404).send("There are no pending jobs yet. Please try again later.")),!0},post_task:function(a,b){var c=this,d=a.connection.remoteAddress+"";a.body&&Array.isArray(a.body.jobs)?(b.send("Thank you."),a.body.jobs.forEach(function(a){a.postedFrom=d,c.processResult(a)})):b.status(400).send("Invalid post.")},get_stats:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(this.statistics)},get_store:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(this.store.status())},configureApp:function(a){var b=this.config;a=a||d(),a.use(q.json()),b.compression&&a.use(require("compression")());var c=b.staticRoute;return a.get("/",function(a,b){b.redirect(c+"/index.html")}),a.get(b.routes.task||c+"/task.json",this.get_task.bind(this)),a.post(b.routes.task||c+"/task.json",this.post_task.bind(this)),a.get(b.routes.config||c+"/config.json",this.get_config.bind(this)),a.get(b.routes.stats||c+"/stats.json",this.get_stats.bind(this)),a.get(b.routes.store||c+"/store.json",this.get_store.bind(this)),"function"==typeof b.authentication&&[c,b.taskRoute,b.configRoute,b.statsRoute].forEach(function(c){a.use(c,d.basicAuth(b.authentication.bind(this,c)))}),this.__configureAppFiles__(a),a},__configureAppFiles__:function(a){var e=this,f=this.config;a=a||d(),a.use(f.staticRoute,d["static"](f.serverFiles)),"string"==typeof f.customFiles&&(f.customFiles=f.customFiles.split("\n")),f.customFiles.forEach(function(d){if("string"==typeof d&&(d={path:d}),d.path){var f=b.resolve(d.path.trim());if(c.existsSync(f)){var g=c.lstatSync(f);g.isDirectory()?e.__serveDirectory__(f,d.route,a):g.isFile()&&e.__serveFile__(f,d.route,a)}else console.error("Custom files' path <"+f+"> does not exist!")}else d.module&&e.__serveNodeModule__(d.module,route,a)})},__serveDirectory__:function(a,b,c){c=c||this.expressApp,b=b||this.config.staticRoute,c.use(b,d["static"](a))},__serveFile__:function(a,c,d){d=d||this.expressApp,c=c||this.config.staticRoute+"/"+b.basename(a),d.get(c,function(b,c){c.sendFile(a,{})})},__serveRequireModule__:function(a,b,c,d,e){b=b||a.name,c=c||a.dependencies||[],e=e||this.expressApp,d=d||this.config.staticRoute+"/"+b+".js",e.get(d,function(b,d){d.send("define("+JSON.stringify(c)+","+a+");")})},__serveNodeModule__:function(a,c,d){var e,f;if("string"==typeof a)e=require.resolve(a),f=a;else{a instanceof module.constructor||(a=l(require.cache).filterApply(function(b,c){return c.exports===a},function(a,b){return b}).head(null),i(!a,"Given module object was not found in require.cache!")),e=a.filename;var g=/node_modules(?:\/@.*?)?\/(.*?)\//.exec(e);f=a.exports.__package__||g&&g[1]||b.basename(e,".js")}return c=c||this.config.staticRoute+"/"+f+".js",this.__serveFile__(e,c,d)},"static run":function(a){var b=new r(a),c=b.config.port;return b.logger.info("Setting up the Capataz server."),b.expressApp=b.configureApp(a.app),b.expressApp.listen(c),b.logger.info("Server started and listening at port ",c,"."),b},scheduleAll:function(a,b,c){var d=l(a).__iter__(),e=this;return b=isNaN(b)?this.config.maxScheduled:Math.min(0|+b,this.config.maxScheduled),n.doWhile(function(){var a,f=[];try{for(var g=0;g<b;++g)a=e.schedule(d()),f.push(c?c(a):a)}catch(h){m.prototype.catchStop(h)}return!(f.length<1)&&n.all(f)})}}),s=a.Store=h({constructor:function(a){j(this,a).number("maxScheduled",{defaultValue:5e3,coerce:!0}).object("statistics",{ignore:!0}),this.__count__=0},store:function(a){return e.raiseIf(Object.keys(this.__pending__).length>=this.maxScheduled,"Cannot schedule more jobs: the maximum amount (",this.maxScheduled,") has been reached!"),a.id=this.__count__=this.__count__+1&2147483647,a.future=new n,a.scheduledSince=Date.now(),a.assignedSince=1/0,a.resolvedSince=1/0,a.rejectedSince=1/0,this.statistics&&this.statistics.add(g({key:"scheduled"},a.tags)),a},task:e.objects.unimplemented("Store","task"),assigned:e.objects.unimplemented("Store","assigned"),status:e.objects.unimplemented("Store","store"),onJobResolve:function(a,b){a.result=b,a.resolvedSince=Date.now()},onJobReject:function(a,b){a.error=b,a.rejectedSince=Date.now()},__take__:function(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)){if(--b<0)break;d.push([e,a[e]]),c&&delete a[e]}return d}}),t=a.MemoryStore=h(s,{constructor:function(a){s.call(this,a),j(this,a).bool("keepResolved",{defaultValue:!1,coerce:!0}).bool("keepRejected",{defaultValue:!1,coerce:!0}),this.__pending__={},this.__assigned__={},this.keepResolved&&(this.__resolved__={}),this.keepRejected&&(this.__rejected__={})},store:function(a){return a=s.prototype.store.call(this,a),a.future.done(this.onJobResolve.bind(this,a)),a.future.fail(this.onJobReject.bind(this,a)),this.__pending__[a.id]=a,a},task:function(a){var b=this,c=this.__take__(this.__pending__,a,!0).map(function(a){var c=a[0],d=a[1];return b.__assigned__[c]=d,d.assignedSince=Date.now(),d});return c.length<a&&(c=c.concat(this.__take__(this.__assigned__,a-c.length).map(function(a){return a[1]}))),c},assigned:function(a){return this.__assigned__[a]},status:function(){var a={count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)};return this.__resolved__&&(a.resolved=Object.keys(this.__resolved__)),this.__rejected__&&(a.rejected=Object.keys(this.__rejected__)),a},onJobResolve:function(a,b){this.__assigned__.hasOwnProperty(a.id)&&(delete this.__assigned__[a.id],s.prototype.onJobResolve.call(this,a,b),this.keepResolved&&(this.__resolved__[a.id]=a))},onJobReject:function(a,b){this.__assigned__.hasOwnProperty(a.id)&&(delete this.__assigned__[a.id],s.prototype.onJobReject.call(this,a,b),this.keepRejected&&(this.__rejected__[a.id]=a))}});a.FileStore=h(s,{constructor:function(a){s.call(this,a),j(this,a).string("storeFileFolder",{defaultValue:"./tmp",coerce:!0}),this.__count__=0,this.__pending__={},this.__assigned__={}},jobFilePath:function(a){return this.storeFileFolder+"/job-"+k.lpad(+a+"",10,"0")+".json"},readJob:function(a,b){var d=this.jobFilePath(a),e=c.readFileSync(d,{encoding:"utf8"}),f=JSON.parse(e);return f.future=b,f},writeJob:function(a){var b=this.jobFilePath(a.id),d=JSON.stringify(g({future:void 0},a),null,"\t");return c.writeFileSync(b,d,{encoding:"utf8"}),b},store:function(a){return a=s.prototype.store.call(this,a),this.writeJob(a),this.__pending__[a.id]=a.future,a.future.done(this.onJobResolve.bind(this,a.id)),a.future.fail(this.onJobReject.bind(this,a.id)),a},task:function(a){var b=this,c=this.__take__(this.__pending__,a,!0).map(function(a){var c=a[0],d=a[1],e=b.readJob(c,d);return b.__assigned__[c]=d,e.assignedSince=Date.now(),b.writeJob(e),e});return c.length<a&&(c=c.concat(this.__take__(this.__assigned__,a-c.length).map(function(a){return b.readJob(a[0],a[1])}))),c},assigned:function(a){var b=this.__assigned__[a];return b?this.readJob(a,b):void 0},status:function(){return{count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)}},onJobResolve:function(a,b){if(this.__assigned__[a]){var c=this.__assigned__[a];delete this.__assigned__[a];var d=this.readJob(a,c);s.prototype.onJobResolve.call(this,d,b),this.writeJob(d)}},onJobReject:function(a,b){if(this.__assigned__[a]){var c=this.__assigned__[a];delete this.__assigned__[a];var d=this.readJob(a,c);s.prototype.onJobReject.call(this,d,b),this.writeJob(d)}}})}(exports);