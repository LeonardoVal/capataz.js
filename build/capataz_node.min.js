//! capataz 0.1.7-beta

!function(e){"use strict";var r=require("path"),o=require("fs"),a=require("express"),t=require("creatartis-base"),s=require("sermat");s.modifiers.mode=s.CIRCULAR_MODE,s.include("Function"),e.__package__="capataz_node",e.__name__="capataz_node",e.__dependencies__=[a,t,s],e.__SERMAT__={include:[]};var i=t.copy,n=t.declare,c=t.raiseIf,u=t.initialize,_=t.Text,d=t.iterable,l=t.Iterable,h=t.Future,f=t.Logger,g=t.Statistics,p=require("body-parser"),m=e.Capataz=n({constructor:function(e){u(this.config={},e).integer("workerCount",{defaultValue:2,coerce:!0}).integer("useWebworkers",{defaultValue:1,coerce:!0}).bool("adjustWorkerCount",{defaultValue:!0,coerce:!0}).number("maxRetries",{defaultValue:100,coerce:!0}).integer("minDelay",{defaultValue:100,coerce:!0}).number("maxDelay",{defaultValue:9e5,coerce:!0}).number("desiredEvaluationTime",{defaultValue:1e4,coerce:!0}).number("maxTaskSize",{defaultValue:50,coerce:!0}).number("evaluationTimeGainFactor",{defaultValue:.9,coerce:!0}).number("maxScheduled",{defaultValue:5e3,coerce:!0}).integer("port",{defaultValue:8080,coerce:!0}).string("staticRoute",{defaultValue:"/capataz"}).string("serverFiles",{defaultValue:r.dirname(module.filename)+"/static"}).object("routes",{defaultValue:{}}).func("authentication",{ignore:!0}).bool("compression",{defaultValue:!0,coerce:!0}).string("logFile",{defaultValue:_.formatDate(new Date,'"capataz-"yyyymmdd-hhnnss".log"')}),this.config.customFiles=e.customFiles||[],u(this,e).object("statistics",{defaultValue:new g}).object("logger",{defaultValue:f.ROOT}).object("store",{defaultValue:new v(e)}),this.logger&&(this.logger.appendToConsole(),this.config.logFile&&this.logger.appendToFile(this.config.logFile)),this.__startTime__=Date.now()},schedule:function(e){this.__accountServerStats__(),e.fun||raise("Cannot schedule ",JSON.stringify(e),", it has no `fun`!");var t=this.store.store({info:e.info,imports:e.imports,args:e.args,fun:e.fun,tags:e.tags}).future;return t.fail(this.logger.error.bind(this.logger)),t},__accountServerStats__:function(){var t=this.statistics,s=process.memoryUsage();["rss","heapUsed","heapTotal"].forEach(function(e){t.add({key:"memory",type:e},s[e])})},taskSize:function(){var e=this.statistics.stat({key:"estimated_time"}),t=Math.max(1,e.average());return e.count()<=3?1:Math.round(Math.max(1,Math.min(this.config.maxTaskSize,this.config.desiredEvaluationTime/t)))},nextTask:function(e){return isNaN(e)&&(e=this.taskSize()),{serverStartTime:this.__startTime__,jobs:this.store.task(e).map(function(e){return{id:e.id,info:(e.info||"")+"",imports:e.imports||[],args:e.args||[],fun:e.fun+"",assignedSince:Date.now()}})}},postIsInvalid:function(e){return isNaN(e.assignedSince)||e.assignedSince<this.__startTime__||e.assignedSince>Date.now()||e.time<=0},processResult:function(e){this.__accountServerStats__();var t,s=this.store.assigned(e.id);s?this.postIsInvalid(e)?(this.logger.warn("Posted result for ",e.id," is not valid. Ignoring POST."),t="invalid"):void 0!==e.error?(t="rejected",s.future.reject(e.error)):(t="resolved",s.future.resolve(e.result)):(this.logger.debug("Job ",e.id," not found. Ignoring POST."),t="ignored"),s&&this.accountPost(e,s,t)},accountPost:function(e,t,s){"resolved"===s&&this.statistics.gain({key:"estimated_time"},e.time,this.config.evaluationTimeGainFactor),this.statistics.add(i({key:"evaluation_time",status:s,platform:e.clientPlatform,client:e.postedFrom},t&&t.tags),e.time),this.statistics.add(i({key:"roundtrip_time",status:s,platform:e.clientPlatform,client:e.postedFrom},t&&t.tags),Date.now()-e.assignedSince)},get_config:function(e,t){t.set("Cache-Control","max-age=0,no-cache,no-store"),t.json({jobURI:this.config.taskRoute,workerCount:this.config.workerCount,adjustWorkerCount:this.config.adjustWorkerCount,maxRetries:this.config.maxRetries,minDelay:this.config.minDelay,maxDelay:this.config.maxDelay,useWebworkers:this.config.useWebworkers})},get_task:function(e,t){var s=this.nextTask();return 0<s.jobs.length?(t.set("Cache-Control","max-age=0,no-cache,no-store"),t.json(s),this.statistics.add({key:"jobs_per_task"},s.jobs.length)):(this.logger.debug("There are no pending jobs yet."),t.status(404).send("There are no pending jobs yet. Please try again later.")),!0},post_task:function(e,t){var s=this,i=e.connection.remoteAddress+"";e.body&&Array.isArray(e.body.jobs)?(t.send("Thank you."),e.body.jobs.forEach(function(e){e.postedFrom=i,s.processResult(e)})):t.status(400).send("Invalid post.")},get_stats:function(e,t){t.set("Cache-Control","max-age=0,no-cache,no-store"),t.json(this.statistics)},get_store:function(e,t){t.set("Cache-Control","max-age=0,no-cache,no-store"),t.json(this.store.status())},configureApp:function(t){var s=this.config;(t=t||a()).use(p.json()),s.compression&&t.use(require("compression")());var i=s.staticRoute;return t.get("/",function(e,t){t.redirect(i+"/index.html")}),t.get(s.routes.task||i+"/task.json",this.get_task.bind(this)),t.post(s.routes.task||i+"/task.json",this.post_task.bind(this)),t.get(s.routes.config||i+"/config.json",this.get_config.bind(this)),t.get(s.routes.stats||i+"/stats.json",this.get_stats.bind(this)),t.get(s.routes.store||i+"/store.json",this.get_store.bind(this)),"function"==typeof s.authentication&&[i,s.taskRoute,s.configRoute,s.statsRoute].forEach(function(e){t.use(e,a.basicAuth(s.authentication.bind(this,e)))}),this.__configureAppFiles__(t),t},__configureAppFiles__:function(i){var n=this,e=this.config;return(i=i||a()).use(e.staticRoute,a.static(e.serverFiles)),"string"==typeof e.customFiles&&(e.customFiles=e.customFiles.split("\n")),e.customFiles.forEach(function(e){if("string"==typeof e?e={path:e}:e instanceof module.constructor&&(e={module:e}),e.path){var t=r.resolve(e.path.trim());if(o.existsSync(t)){var s=o.lstatSync(t);s.isDirectory()?n.__serveDirectory__(t,e.route,i):s.isFile()&&n.__serveFile__(t,e.route,i)}else console.error("Custom files' path <"+t+"> does not exist!")}else e.module&&n.__serveNodeModule__(e.module,e.route,i)}),i},__serveDirectory__:function(e,t,s){return s=s||this.expressApp,t=t||this.config.staticRoute,s.use(t,a.static(e)),this},__serveFile__:function(s,e,t){return t=t||this.expressApp,e=e||this.config.staticRoute+"/"+r.basename(s),t.get(e,function(e,t){t.sendFile(s,{})}),this},__serveRequireModule__:function(s,e,i,t,n){return e=e||s.name,i=i||s.dependencies||[],n=n||this.expressApp,t=t||this.config.staticRoute+"/"+e+".js",n.get(t,function(e,t){t.send("define("+JSON.stringify(i)+","+s+");")}),this},__serveNodeModule__:function(s,e,t){var i,n;if("string"==typeof s)i=require.resolve(s),n=s;else{s instanceof module.constructor||(s=d(require.cache).filterApply(function(e,t){return t.exports===s},function(e,t){return t}).head(null),c(!s,"Given module object was not found in require.cache!")),i=s.filename;var o=/node_modules(?:\/@.*?)?\/(.*?)\//.exec(i);n=s.exports.__package__||o&&o[1]||r.basename(i,".js")}return e=e||this.config.staticRoute+"/"+n+".js",this.__serveFile__(i,e,t),this},"static run":function(e){var t=new m(e),s=t.config.port;return t.logger.info("Setting up the Capataz server."),t.expressApp=t.configureApp(e.app),t.expressApp.listen(s),t.logger.info("Server started and listening at port ",s,"."),t},scheduleAll:function(e,i,n){var o=d(e).__iter__(),r=this;return i=isNaN(i)?this.config.maxScheduled:Math.min(0|+i,this.config.maxScheduled),h.doWhile(function(){var e,t=[];try{for(var s=0;s<i;++s)e=r.schedule(o()),t.push(n?n(e):e)}catch(e){l.prototype.catchStop(e)}return!(t.length<1)&&h.all(t)})}}),b=e.Store=n({constructor:function(e){u(this,e).number("maxScheduled",{defaultValue:5e3,coerce:!0}).object("statistics",{ignore:!0}).object("random",{defaultValue:t.Randomness.DEFAULT}),this.__count__=0},store:function(e){return t.raiseIf(Object.keys(this.__pending__).length>=this.maxScheduled,"Cannot schedule more jobs: the maximum amount (",this.maxScheduled,") has been reached!"),e.id=this.__count__=this.__count__+1&2147483647,e.future=new h,e.scheduledSince=Date.now(),e.assignedSince=1/0,e.resolvedSince=1/0,e.rejectedSince=1/0,this.statistics&&this.statistics.add(i({key:"scheduled"},e.tags)),e},task:t.objects.unimplemented("Store","task"),assigned:t.objects.unimplemented("Store","assigned"),status:t.objects.unimplemented("Store","store"),onJobResolve:function(e,t){e.result=t,e.resolvedSince=Date.now()},onJobReject:function(e,t){e.error=t,e.rejectedSince=Date.now()},__take__:function(t,e,s){return this.random.choices(e,t).map(function(e){return s&&delete t[e[0]],e})}}),v=e.MemoryStore=n(b,{constructor:function(e){b.call(this,e),u(this,e).bool("keepResolved",{defaultValue:!1,coerce:!0}).bool("keepRejected",{defaultValue:!1,coerce:!0}),this.__pending__={},this.__assigned__={},this.keepResolved&&(this.__resolved__={}),this.keepRejected&&(this.__rejected__={})},store:function(e){return(e=b.prototype.store.call(this,e)).future.done(this.onJobResolve.bind(this,e)),e.future.fail(this.onJobReject.bind(this,e)),this.__pending__[e.id]=e},task:function(e){var i=this,t=this.__take__(this.__pending__,e,!0).map(function(e){var t=e[0],s=e[1];return(i.__assigned__[t]=s).assignedSince=Date.now(),s});return t.length<e&&(t=t.concat(this.__take__(this.__assigned__,e-t.length).map(function(e){return e[1]}))),t},assigned:function(e){return this.__assigned__[e]},status:function(){var e={count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)};return this.__resolved__&&(e.resolved=Object.keys(this.__resolved__)),this.__rejected__&&(e.rejected=Object.keys(this.__rejected__)),e},onJobResolve:function(e,t){this.__assigned__.hasOwnProperty(e.id)&&(delete this.__assigned__[e.id],b.prototype.onJobResolve.call(this,e,t),this.keepResolved&&(this.__resolved__[e.id]=e))},onJobReject:function(e,t){this.__assigned__.hasOwnProperty(e.id)&&(delete this.__assigned__[e.id],b.prototype.onJobReject.call(this,e,t),this.keepRejected&&(this.__rejected__[e.id]=e))}});e.FileStore=n(b,{constructor:function(e){b.call(this,e),u(this,e).string("storeFileFolder",{defaultValue:"./tmp",coerce:!0}),this.__count__=0,this.__pending__={},this.__assigned__={}},jobFilePath:function(e){return this.storeFileFolder+"/job-"+_.lpad(+e+"",10,"0")+".json"},readJob:function(e,t){var s=this.jobFilePath(e),i=o.readFileSync(s,{encoding:"utf8"}),n=JSON.parse(i);return n.future=t,n},writeJob:function(e){var t=this.jobFilePath(e.id),s=JSON.stringify(i({future:void 0},e),null,"\t");return o.writeFileSync(t,s,{encoding:"utf8"}),t},store:function(e){return e=b.prototype.store.call(this,e),this.writeJob(e),this.__pending__[e.id]=e.future,e.future.done(this.onJobResolve.bind(this,e.id)),e.future.fail(this.onJobReject.bind(this,e.id)),e},task:function(e){var n=this,t=this.__take__(this.__pending__,e,!0).map(function(e){var t=e[0],s=e[1],i=n.readJob(t,s);return n.__assigned__[t]=s,i.assignedSince=Date.now(),n.writeJob(i),i});return t.length<e&&(t=t.concat(this.__take__(this.__assigned__,e-t.length).map(function(e){return n.readJob(e[0],e[1])}))),t},assigned:function(e){var t=this.__assigned__[e];return t?this.readJob(e,t):void 0},status:function(){return{count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)}},onJobResolve:function(e,t){if(this.__assigned__[e]){var s=this.__assigned__[e];delete this.__assigned__[e];var i=this.readJob(e,s);b.prototype.onJobResolve.call(this,i,t),this.writeJob(i)}},onJobReject:function(e,t){if(this.__assigned__[e]){var s=this.__assigned__[e];delete this.__assigned__[e];var i=this.readJob(e,s);b.prototype.onJobReject.call(this,i,t),this.writeJob(i)}}})}(exports);