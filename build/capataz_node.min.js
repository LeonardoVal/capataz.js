//! capataz 0.1.3
!function(a){"use strict";var b=require("creatartis-base"),c=require("express"),d=require("path"),e=require("fs");a.__name__="capataz_node",a.__dependencies__={base:b,express:c};{var f=b.copy,g=b.declare,h=b.initialize,i=b.Text,j=b.iterable,k=b.Iterable,l=b.Future,m=b.Logger,n=b.Statistics,o=a.Capataz=g({constructor:function(a){h(this.config={},a).integer("workerCount",{defaultValue:2,coerce:!0}).number("maxRetries",{defaultValue:100,coerce:!0}).integer("minDelay",{defaultValue:100,coerce:!0}).number("maxDelay",{defaultValue:9e5,coerce:!0}).integer("useWebworkers",{defaultValue:1,coerce:!0}).number("desiredEvaluationTime",{defaultValue:1e4,coerce:!0}).number("maxTaskSize",{defaultValue:50,coerce:!0}).number("evaluationTimeGainFactor",{defaultValue:.9,coerce:!0}).number("maxScheduled",{defaultValue:5e3,coerce:!0}).integer("port",{defaultValue:8080,coerce:!0}).string("staticRoute",{defaultValue:"/capataz"}).string("serverFiles",{defaultValue:d.dirname(module.filename)+"/static"}).string("customFiles",{defaultValue:""}).object("routes",{defaultValue:{}}).func("authentication",{ignore:!0}).bool("compression",{defaultValue:!0,coerce:!0}).string("logFile",{defaultValue:i.formatDate(new Date,'"capataz-"yyyymmdd-hhnnss".log"')}),h(this,a).object("statistics",{defaultValue:new n}).object("logger",{defaultValue:m.ROOT}).object("store",{defaultValue:new q(a)}),this.logger&&(this.logger.appendToConsole(),this.config.logFile&&this.logger.appendToFile(this.config.logFile)),this.__startTime__=Date.now()},schedule:function(a){return a.fun||raise("Cannot schedule ",JSON.stringify(a),", it has no `fun`!"),this.store.store({info:a.info,imports:a.imports,args:a.args,fun:a.fun,tags:a.tags}).future},taskSize:function(){var a=Math.max(1,this.statistics.average({key:"estimated_time"}));return Math.round(Math.max(1,Math.min(this.config.maxTaskSize,this.config.desiredEvaluationTime/a)))},nextTask:function(a){if(isNaN(a)){var b=Math.max(1,this.statistics.average({key:"estimated_time"}));a=Math.round(Math.max(1,Math.min(this.config.maxTaskSize,this.config.desiredEvaluationTime/b)))}return{serverStartTime:this.__startTime__,jobs:this.store.task(a).map(function(a){return{id:a.id,info:(a.info||"")+"",imports:a.imports||[],args:a.args||[],fun:a.fun+"",assignedSince:Date.now()}})}},postIsInvalid:function(a){return isNaN(a.assignedSince)||a.assignedSince<this.__startTime__||a.assignedSince>Date.now()||a.time<=0},processResult:function(a){var b,c=this.store.assigned(a.id);c?this.postIsInvalid(a)?(this.logger.warn("Posted result for ",id," is not valid. Ignoring POST."),this.jobs[id]=c,b="invalid"):"undefined"!=typeof a.error?(b="rejected",c.future.reject(a.error)):(b="resolved",c.future.resolve(a.result)):(this.logger.debug("Job ",a.id," not found. Ignoring POST."),b="ignored"),this.accountPost(a,c,b)},accountPost:function(a,b,c){"resolved"==c&&this.statistics.gain({key:"estimated_time"},a.time,this.config.evaluationTimeGainFactor),this.statistics.add(f({key:"evaluation_time",status:c,platform:a.clientPlatform,client:a.postedFrom},b&&b.tags),a.time),this.statistics.add(f({key:"roundtrip_time",status:c,platform:a.clientPlatform,client:a.postedFrom},b&&b.tags),Date.now()-a.assignedSince)},get_config:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json({jobURI:this.config.taskRoute,workerCount:this.config.workerCount,maxRetries:this.config.maxRetries,minDelay:this.config.minDelay,maxDelay:this.config.maxDelay,useWebworkers:this.config.useWebworkers})},get_task:function(a,b){var c=this.nextTask();return c.jobs.length>0?(b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(c),this.statistics.add({key:"jobs_per_task"},c.jobs.length)):(this.logger.debug("There are no pending jobs yet."),b.send(404,"There are no pending jobs yet. Please try again later.")),!0},post_task:function(a,b){var c=this,d=a.connection.remoteAddress+"";a.body&&Array.isArray(a.body.jobs)?(b.send("Thank you."),a.body.jobs.forEach(function(a){a.postedFrom=d,c.processResult(a)})):b.send(400,"Invalid post.")},get_stats:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(this.statistics)},get_store:function(a,b){b.set("Cache-Control","max-age=0,no-cache,no-store"),b.json(this.store.status())},configureApp:function(a){var b=this.config;return a=a||c(),a.use(c.json()),b.compression&&a.use(c.compress()),a.get("/",function(a,c){c.redirect(b.staticRoute+"/index.html")}),a.get(b.routes.task||"/capataz/task.json",this.get_task.bind(this)),a.post(b.routes.task||"/capataz/task.json",this.post_task.bind(this)),a.get(b.routes.config||"/capataz/config.json",this.get_config.bind(this)),a.get(b.routes.stats||"/capataz/stats.json",this.get_stats.bind(this)),a.get(b.routes.store||"/capataz/store.json",this.get_store.bind(this)),"function"==typeof b.authentication&&[b.staticRoute,b.taskRoute,b.configRoute,b.statsRoute].forEach(function(d){a.use(d,c.basicAuth(b.authentication.bind(this,d)))}),a.use(b.staticRoute,c["static"](b.serverFiles)),b.customFiles.split("\n").forEach(function(d){d=d.trim(),d&&a.use(b.staticRoute,c["static"](d))}),a},"static run":function(a){var b=new o(a),c=b.config.port;return b.logger.info("Setting up the Capataz server."),b.expressApp=b.configureApp(a.app),b.expressApp.listen(c),b.logger.info("Server started and listening at port ",c,"."),b},scheduleAll:function(a,b,c){var d=j(a).__iter__(),e=this;return b=isNaN(b)?this.config.maxScheduled:Math.min(0|+b,this.config.maxScheduled),l.doWhile(function(){var a,f=[];try{for(var g=0;b>g;++g)a=e.schedule(d()),f.push(c?c(a):a)}catch(h){k.prototype.catchStop(h)}return f.length<1?!1:l.all(f)})}}),p=a.Store=g({constructor:function(a){h(this,a).number("maxScheduled",{defaultValue:5e3,coerce:!0}).object("statistics",{ignore:!0}),this.__count__=0},store:function(a){return b.raiseIf(Object.keys(this.__pending__).length>=this.maxScheduled,"Cannot schedule more jobs: the maximum amount (",this.maxScheduled,") has been reached!"),a.id=this.__count__=this.__count__+1&2147483647,a.future=new l,a.scheduledSince=Date.now(),a.assignedSince=1/0,a.resolvedSince=1/0,a.rejectedSince=1/0,this.statistics&&this.statistics.add(f({key:"scheduled"},a.tags)),a},task:b.objects.unimplemented("Store","task"),assigned:b.objects.unimplemented("Store","assigned"),status:b.objects.unimplemented("Store","store"),onJobResolve:function(a,b){a.result=b,a.resolvedSince=Date.now()},onJobReject:function(a,b){a.error=b,a.rejectedSince=Date.now()},__take__:function(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)){if(--b<0)break;d.push([e,a[e]]),c&&delete a[e]}return d}}),q=a.MemoryStore=g(p,{constructor:function(a){p.call(this,a),h(this,a).bool("keepResolved",{defaultValue:!1,coerce:!0}).bool("keepRejected",{defaultValue:!1,coerce:!0}),this.__pending__={},this.__assigned__={},this.keepResolved&&(this.__resolved__={}),this.keepRejected&&(this.__rejected__={})},store:function(a){return a=p.prototype.store.call(this,a),a.future.done(this.onJobResolve.bind(this,a)),a.future.fail(this.onJobReject.bind(this,a)),this.__pending__[a.id]=a,a},task:function(a){var b=this,c=this.__take__(this.__pending__,a,!0).map(function(a){var c=a[0],d=a[1];return b.__assigned__[c]=d,d.assignedSince=Date.now(),d});return c.length<a&&(c=c.concat(this.__take__(this.__assigned__,a-c.length).map(function(a){return a[1]}))),c},assigned:function(a){return this.__assigned__[a]},status:function(){var a={count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)};return this.__resolved__&&(a.resolved=Object.keys(this.__resolved__)),this.__rejected__&&(a.rejected=Object.keys(this.__rejected__)),a},onJobResolve:function(a,b){this.__assigned__.hasOwnProperty(a.id)&&(delete this.__assigned__[a.id],p.prototype.onJobResolve.call(this,a,b),this.keepResolved&&(this.__resolved__[a.id]=a))},onJobReject:function(a,b){this.__assigned__.hasOwnProperty(a.id)&&(delete this.__assigned__[a.id],p.prototype.onJobReject.call(this,a,b),this.keepRejected&&(this.__rejected__[a.id]=a))}});a.FileStore=g(p,{constructor:function(a){p.call(this,a),h(this,a).string("storeFileFolder",{defaultValue:"./tmp",coerce:!0}),this.__count__=0,this.__pending__={},this.__assigned__={}},jobFilePath:function(a){return this.storeFileFolder+"/job-"+i.lpad(+a+"",10,"0")+".json"},readJob:function(a,b){var c=this.jobFilePath(a),d=e.readFileSync(c,{encoding:"utf8"}),f=JSON.parse(d);return f.future=b,f},writeJob:function(a){var b=this.jobFilePath(a.id),c=JSON.stringify(f({future:void 0},a),null,"	");return e.writeFileSync(b,c,{encoding:"utf8"}),b},store:function(a){return a=p.prototype.store.call(this,a),this.writeJob(a),this.__pending__[a.id]=a.future,a.future.done(this.onJobResolve.bind(this,a.id)),a.future.fail(this.onJobReject.bind(this,a.id)),a},task:function(a){var b=this,c=this.__take__(this.__pending__,a,!0).map(function(a){var c=a[0],d=a[1],e=b.readJob(c,d);return b.__assigned__[c]=d,e.assignedSince=Date.now(),b.writeJob(e),e});return c.length<a&&(c=c.concat(this.__take__(this.__assigned__,a-c.length).map(function(a){return b.readJob(a[0],a[1])}))),c},assigned:function(a){var b=this.__assigned__[a];return b?this.readJob(a,b):void 0},status:function(){return{count:this.__count__,pending:Object.keys(this.__pending__),assigned:Object.keys(this.__assigned__)}},onJobResolve:function(a,b){if(this.__assigned__[a]){var c=this.__assigned__[a];delete this.__assigned__[a];var d=this.readJob(a,c);p.prototype.onJobResolve.call(this,d,b),this.writeJob(d)}},onJobReject:function(a,b){if(this.__assigned__[a]){var c=this.__assigned__[a];delete this.__assigned__[a];var d=this.readJob(a,c);p.prototype.onJobReject.call(this,d,b),this.writeJob(d)}}})}}(exports);