//! capataz 0.1.1
require(["creatartis-base"],function(base){"use strict";window.base=base;var APP=window.APP={},CONFIG=APP.CONFIG={startTime:Date.now(),jobURI:"/job",workerCount:2,maxRetries:50,minDelay:100,maxDelay:12e4},LOGGER=APP.LOGGER=base.Logger.ROOT;LOGGER.appendToHtml("log",30),LOGGER.info("Starting "+CONFIG.workerCount+" workers."),APP.Drudger=base.declare({constructor:function(){},initialize:function(){var a=new base.Future;return"function"==typeof Worker?(this.webworker=new Worker("capataz_worker.js"),this.webworker.onmessage=function(b){a.resolve(b.data||!0)}):a.resolve(!1),a},onWorkerMessage:function(a,b){var c=JSON.parse(b.data);c.hasOwnProperty("error")?a.reject(c.error):c.hasOwnProperty("result")&&a.resolve(c.result)},getTask:function(){return base.Future.retrying(function(){return LOGGER.info("< Requesting jobs."),base.HttpRequest.getJSON(CONFIG.jobURI).then(function(a){return a.serverStartTime>CONFIG.startTime&&(LOGGER.info("> Definitions are outdated. Reloading..."),window.location.reload()),LOGGER.info("> Received "+a.jobs.length+" jobs. E.g.: "+a.jobs[0].info),a},function(a){throw LOGGER.warn("! Job request failed: ",a.status," ",a.statusText,": ",a.responseText,""),new Error("Job request failed!")})},CONFIG.maxRetries,CONFIG.minDelay,2,CONFIG.maxDelay).fail(function(){LOGGER.error("Job request failed too many times. Not retrying anymore.")})},doJob:function doJob(job){var drudger=this;if(this.webworker){var future=new base.Future;return this.webworker.onmessage=this.onWorkerMessage.bind(this,future),this.webworker.postMessage(JSON.stringify(job)),future}return base.Future.invoke(eval,this,job.code)},doWork:function(a){var b=this;return base.Future.sequence(a.jobs,function(a){return a.clientPlatform=navigator.platform,a.startedAt=Date.now(),b.doJob(a).then(function(b){return a.result=b,a.time=Date.now()-a.startedAt,LOGGER.debug("> ",a.info," -> ",b),a},function(b){return a.error=b,a.time=Date.now()-a.startedAt,LOGGER.warn("> ",a.info," !! ",b),a})}).then(function(){return a})},postResults:function(a){return base.Future.retrying(function(){return LOGGER.info("< Posting results."),base.HttpRequest.postJSON(CONFIG.jobURI,a).fail(function(a){LOGGER.warn("! Posting failed: ",a.status," ",a.statusText," ",a.responseText,".")})},CONFIG.maxRetries,CONFIG.minDelay,2,CONFIG.maxDelay).fail(function(){LOGGER.error("Job result post failed too many times. Not retrying anymore.")})},drudge:function(){var a=this;return base.Future.doWhile(function(){return a.getTask().then(a.doWork.bind(a)).then(a.postResults.bind(a))},function(){return!0}).fail(function(a){LOGGER.error("Uncaught error on drudger! "+a)})}}),APP.start=function(){APP.drudgers=base.Iterable.range(CONFIG.workerCount).map(function(){return new APP.Drudger}).toArray(),base.Future.sequence(APP.drudgers,function(a){return a.initialize().done(a.drudge.bind(a))})},"complete"===document.readyState?APP.start():window.addEventListener("load",APP.start,!1)});