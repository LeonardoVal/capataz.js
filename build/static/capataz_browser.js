//! capataz 0.1.4
require(["creatartis-base"],function(base){"use strict";window.base=base;var APP=window.APP={},LOGGER=APP.LOGGER=base.Logger.ROOT,CONFIG;APP.Drudger=base.declare({constructor:function(){},initialize:function(a){a=0|a;var b=new base.Future;return a>=0&&"undefined"!=typeof Worker?(this.webworker=new Worker("capataz_worker.js"),this.webworker.onmessage=function(a){b.resolve(a.data||!0)}):a>0?b.reject("Webworkers are required but are not supported in this browser!"):b.resolve(!1),b},onWorkerMessage:function(a,b){var c=JSON.parse(b.data);c.hasOwnProperty("error")?a.reject(c.error):c.hasOwnProperty("result")&&a.resolve(c.result)},getTask:function(){return base.Future.retrying(function(){return LOGGER.info("< Requesting jobs."),base.HttpRequest.getJSON(CONFIG.jobURI).then(function(a){return a.serverStartTime>CONFIG.startTime&&(LOGGER.info("> Definitions are outdated. Reloading..."),window.location.reload()),LOGGER.info("> Received "+a.jobs.length+" jobs. E.g.: "+a.jobs[0].info),a},function(a){throw LOGGER.warn("! Job request failed: ",a.status," ",a.statusText,": ",a.responseText,""),new Error("Job request failed!")})},CONFIG.maxRetries,CONFIG.minDelay,2,CONFIG.maxDelay).fail(function(){LOGGER.error("Job request failed too many times. Not retrying anymore.")})},doWork:function(a){var b=this;return base.Future.sequence(a.jobs,function(a){return a.clientPlatform=navigator.platform,a.startedAt=Date.now(),b.doJob(a).then(function(b){return a.result=b,a.time=Date.now()-a.startedAt,LOGGER.debug("> ",a.info," -> ",b),a},function(b){return a.error=b,a.time=Date.now()-a.startedAt,LOGGER.warn("> ",a.info," !! ",b),a})}).then(function(){return a})},doJob:function doJob(job){var drudger=this;if(this.webworker){var future=new base.Future;return this.webworker.onmessage=this.onWorkerMessage.bind(this,future),this.webworker.postMessage(JSON.stringify(job)),future}return base.Future.invoke(eval,this,job.code)},postResults:function(a){return base.Future.retrying(function(){return LOGGER.info("< Posting results."),base.HttpRequest.postJSON(CONFIG.jobURI,a).fail(function(a){LOGGER.warn("! Posting failed: ",a.status," ",a.statusText," ",a.responseText,".")})},CONFIG.maxRetries,CONFIG.minDelay,2,CONFIG.maxDelay).fail(function(){LOGGER.error("Job result post failed too many times. Not retrying anymore.")})},drudge:function(){var a=this;return base.Future.doWhile(function(){return a.getTask().then(a.doWork.bind(a)).then(a.postResults.bind(a))},function(){return!0}).fail(function(a){LOGGER.error("Uncaught error on drudger! "+a)})}}),APP.start=function(){var a={};return window.location.search.substring(1).split("&").forEach(function(b){b=b.split("=").map(decodeURIComponent),2==b.length&&(a[b[0]]=b[1])}),base.HttpRequest.getJSON(a.configURI||"config.json").then(function(b){CONFIG=APP.CONFIG=base.copy(a,b,{jobURI:"task.json",workerCount:0,maxRetries:50,minDelay:100,maxDelay:12e4,logLength:30}),CONFIG.startTime=Date.now(),LOGGER.appendToHtml("log",CONFIG.logLength);var c=CONFIG.workerCount>0?+CONFIG.workerCount:Math.max(1,-CONFIG.workerCount,navigator.hardwareConcurrency-1|0);return LOGGER.info("Starting "+c+" workers."),APP.drudgers=base.Iterable.range(c).map(function(){return new APP.Drudger}).toArray(),base.Future.sequence(APP.drudgers,function(a){return a.initialize(CONFIG.useWebworkers).done(a.drudge.bind(a))})})},"complete"===document.readyState?APP.start():window.addEventListener("load",APP.start,!1)});